var UI=function(){this.data={},this.timer,this.db=openDatabase("mydb","1.0","tm_database",2097152),this.init=function(t){var e=this;this.db.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS projects (id INTEGER PRIMARY KEY ASC, title TEXT, time INTEGER, created TEXT, last TEXT)")}),this.getLocalStorage(function(){$.get("page-projects.html",function(e){$(".content").html(e),t()})}),$(document).delegate("button.start","click",function(){var t=$(this).attr("data-projectid");e.startCounter(t)}),$(document).delegate("button.stop","click",function(){var t=$(this).attr("data-projectid");e.stopCounter(t)}),$(document).delegate("form.addproject","submit",function(){var t=$("form .title").val();$("form .title").val("");var a={title:t,time:0,created:0,last:0},i=0;for(var o in e.data)i++;return e.data[i+1]=a,e.setLocalStorage(function(){e.showProjects()}),!1})},this.setTimeToSQL=function(t,e){console.log('UPDATE projects SET time = "'+e+'"" WHERE id = "'+t+'"'),this.db.transaction(function(a){a.executeSql("UPDATE projects SET time = "+e+" WHERE id = "+t)})},this.setLocalStorage=function(t){var e=this;this.db.transaction(function(a){for(var i in e.data)a.executeSql('SELECT * FROM projects WHERE title = "'+e.data[i].title+'"',[],function(o,s){var n=s.rows.length;0>=n&&a.executeSql('INSERT INTO projects (id, title, time, created, last) VALUES (null, "'+e.data[i].title+'", "'+e.data[i].time+'", "'+e.data[i].created+'", "'+e.data[i].last+'")'),t()})})},this.setDataToLocal=function(t,e){this.data=t,e()},this.getLocalStorage=function(t){var e=this,a=new Array;this.db.transaction(function(i){i.executeSql("SELECT * FROM projects",[],function(i,o){var s,n=o.rows.length;for(s=0;n>s;s++)a[o.rows.item(s).id]={title:o.rows.item(s).title,time:o.rows.item(s).time,created:o.rows.item(s).created,last:o.rows.item(s).last};e.setDataToLocal(a,t)})})},this.startCounter=function(t){var e=this;window.clearInterval(this.timer),$("button.stop").text("START").removeClass("stop").addClass("start"),$(".project-"+t).find("button.start").text("STOP").removeClass("start").addClass("stop"),this.timer=window.setInterval(function(){e.data[t].time++,e.updateTimes(),e.data[t].time%5==0&&e.setTimeToSQL(t,e.data[t].time)},1e3)},this.stopCounter=function(t){var e=this;$(".project-"+t).find("button.stop").text("START").removeClass("stop").addClass("start"),window.clearInterval(this.timer),e.updateTimes()},this.getProjects=function(t){t()},this.showProjects=function(){$(".projects").html("");for(var t in this.data)$(".projects").append('<div class="project project-'+t+'" data-projectid="'+t+'"><h2>'+this.data[t].title+'</h2><p class="time">'+this.data[t].time+'</p><button data-projectid="'+t+'" class="start">START</button></div>')},this.updateTimes=function(){var t=this;$(".project").each(function(){var e=$(this).attr("data-projectid");$(this).find(".time").text(t.data[e].time)})}},main=new UI;main.init(function(){main.showProjects()});});	$('.project-'+project_id).find('button.start').text('STOP').removeClass('start').addClass('stop');

		this.timer = window.setInterval(function(){
			that.data[project_id].time++;
			that.updateTimes();
			that.setTimeToSQL(project_id,that.data[project_id].time);
		},1000);

	};

	this.stopCounter = function(project_id){
		var that = this;

		// Change button
		$('.project-'+project_id).find('button.stop').text('START').removeClass('stop').addClass('start');

		window.clearInterval(this.timer);
		that.updateTimes();
	};

	this.getProjects = function(callback){
		// Refresh data

		callback();
	};

	this.showProjects = function(){
		$('.projects').html("");
		for(var i in this.data){
			$('.projects').append('<div class="project project-'+i+'" data-projectid="'+i+'"><h2>'+this.data[i].title+'</h2><p class="time">'+this.data[i].time+'</p><button data-projectid="'+i+'" class="start">START</button></div>');
		}
	};

	this.updateTimes = function(){
		var that = this;
		$('.project').each(function(index){
			var project_id = $(this).attr('data-projectid');
			$(this).find('.time').text(that.data[project_id].time);
		});
	}
}

var main = new UI();

main.init(function(){
	main.showProjects();
});
;
s();
});
